# Docker Deployment

## What it does

Simple deployment with a single Docker command.

## Quick Start

```bash
docker run -d \
  -p 8080:8080 \
  -v filey-data:/data \
  -v /path/to/files:/storage \
  filey/filey
```

Visit `http://localhost:8080` to complete setup.

## Volumes

| Container Path | Purpose                                         | Required |
|----------------|-------------------------------------------------|----------|
| `/data`        | SQLite database, config, thumbnails, temp files | Yes      |
| `/storage`     | User files                                      | Yes      |

### /data Contents

```
/data/
  filey.db              # SQLite database
  config.json           # Server configuration (generated by setup)
  .thumbnails/          # Generated thumbnails
  .uploads-temp/        # Incomplete uploads
  logs/                 # Application logs
```

### /storage Structure

```
/storage/
  {user_id}/
    Documents/
    Photos/
    .uploads/           # User's quick upload folder
```

## Environment Variables

| Variable                | Default  | Description                          |
|-------------------------|----------|--------------------------------------|
| `FILEY_PORT`            | 8080     | HTTP server port                     |
| `FILEY_DATA_DIR`        | /data    | Data directory path                  |
| `FILEY_STORAGE_DIR`     | /storage | Storage directory path               |
| `FILEY_LOG_LEVEL`       | info     | Log level (debug, info, warn, error) |
| `FILEY_SESSION_TIMEOUT` | 7d       | Session duration                     |
| `FILEY_TRASH_RETENTION` | 30d      | Days before trash auto-empties       |
| `FILEY_MAX_UPLOAD_SIZE` | 10G      | Maximum single file upload size      |

## Docker Compose

### Basic

```yaml
version: '3.8'

services:
  filey:
    image: filey/filey
    ports:
      - "8080:8080"
    volumes:
      - filey-data:/data
      - ./files:/storage
    restart: unless-stopped

volumes:
  filey-data:
```

### With Reverse Proxy (Traefik)

```yaml
version: '3.8'

services:
  filey:
    image: filey/filey
    volumes:
      - filey-data:/data
      - ./files:/storage
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.filey.rule=Host(`files.example.com`)"
      - "traefik.http.routers.filey.tls.certresolver=letsencrypt"
    restart: unless-stopped

volumes:
  filey-data:
```

### With Reverse Proxy (Nginx Proxy Manager)

```yaml
version: '3.8'

services:
  filey:
    image: filey/filey
    expose:
      - "8080"
    volumes:
      - filey-data:/data
      - ./files:/storage
    networks:
      - proxy
    restart: unless-stopped

networks:
  proxy:
    external: true

volumes:
  filey-data:
```

## Dockerfile

```dockerfile
# Build stage - Frontend
FROM node:20-alpine AS frontend-builder
WORKDIR /app/frontend
COPY apps/web/package*.json ./
RUN npm ci
COPY apps/web/ ./
RUN npm run build

# Build stage - Backend
FROM gradle:8-jdk25 AS backend-builder
WORKDIR /app/backend
COPY apps/server/ ./
RUN gradle build -x test

# Runtime stage
FROM eclipse-temurin:25-jre-alpine
WORKDIR /app

# Install FFmpeg for video thumbnails
RUN apk add --no-cache ffmpeg

# Copy built artifacts
COPY --from=backend-builder /app/backend/build/libs/*.jar app.jar
COPY --from=frontend-builder /app/frontend/dist ./static

# Create directories
RUN mkdir -p /data /storage

# Set environment
ENV FILEY_DATA_DIR=/data
ENV FILEY_STORAGE_DIR=/storage
ENV JAVA_OPTS="-Xmx512m"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

## Health Check

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### Health Endpoint

`GET /api/health`

Response:
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "uptime": 86400,
  "database": "connected",
  "storage": {
    "available": true,
    "freeSpace": 107374182400
  }
}
```

## Backup & Restore

### Backup

```bash
# Stop container (optional, for consistency)
docker stop filey

# Backup database and config
docker run --rm \
  -v filey-data:/data:ro \
  -v $(pwd):/backup \
  alpine tar czf /backup/filey-backup-$(date +%Y%m%d).tar.gz /data

# Backup user files separately (can be large)
tar czf files-backup-$(date +%Y%m%d).tar.gz /path/to/files

# Restart container
docker start filey
```

### Restore

```bash
# Stop container
docker stop filey

# Restore database and config
docker run --rm \
  -v filey-data:/data \
  -v $(pwd):/backup \
  alpine sh -c "rm -rf /data/* && tar xzf /backup/filey-backup-YYYYMMDD.tar.gz -C /"

# Restore files
tar xzf files-backup-YYYYMMDD.tar.gz -C /path/to/files

# Start container
docker start filey
```

## Updating

```bash
# Pull latest image
docker pull filey/filey

# Recreate container
docker-compose up -d

# Or without compose
docker stop filey
docker rm filey
docker run -d \
  --name filey \
  -p 8080:8080 \
  -v filey-data:/data \
  -v /path/to/files:/storage \
  filey/filey
```

## Troubleshooting

### View Logs

```bash
docker logs filey
docker logs -f filey  # Follow
docker logs --tail 100 filey  # Last 100 lines
```

### Enter Container

```bash
docker exec -it filey sh
```

### Check Permissions

```bash
# Ensure volumes are writable
docker exec filey ls -la /data
docker exec filey ls -la /storage
```

### Common Issues

| Issue                     | Solution                                |
|---------------------------|-----------------------------------------|
| Permission denied         | Check volume mount permissions          |
| Port already in use       | Change `-p 8080:8080` to `-p 3000:8080` |
| Database locked           | Only one instance should run at a time  |
| Out of memory             | Increase `JAVA_OPTS` memory limit       |
| Thumbnails not generating | Ensure FFmpeg is installed in container |

## Resource Requirements

### Minimum

- CPU: 1 core
- RAM: 512MB
- Disk: 1GB (plus storage for files)

### Recommended

- CPU: 2 cores
- RAM: 1GB
- Disk: 10GB (plus storage for files)

### Scaling

For most home use cases, a single instance is sufficient. Filey is not designed for horizontal scaling in V1.
